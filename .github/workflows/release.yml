name: Release build

on:
  release:
    types: [published]

jobs:
  build_firmware:
    name: Build ESP32 firmware
    runs-on: self-hosted-linux
    steps:
      - uses: actions/checkout@v3

      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v1
        with:
          version: 'latest'

      - name: Install ESP32 core
        run: |
          arduino-cli core update-index
          arduino-cli core install esp32:esp32

      - name: Compile firmware (release)
        run: |
          FQBN=esp32:esp32:esp32s3:PartitionScheme=huge_app
          arduino-cli compile --fqbn "$${FQBN}" --output-dir build/out-release main

      - name: Compile firmware (debug)
        run: |
          FQBN=esp32:esp32:esp32s3:PartitionScheme=huge_app
          arduino-cli compile --fqbn "$${FQBN}" --build-properties build.type=debug --output-dir build/out-debug main || true

      - name: Prepare artifact directory
        run: mkdir -p artifacts

      - name: Copy compiled binaries
        run: |
          cp build/out-release/*.bin artifacts/sharkos_firmware.bin || true
          cp build/out-debug/*.bin artifacts/sharkos_firmware_debug.bin || true

      - name: Upload release firmware to release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: artifacts/sharkos_firmware.bin
          asset_name: sharkos_firmware.bin
          asset_content_type: application/octet-stream

      - name: Upload debug firmware to release
        if: exists('artifacts/sharkos_firmware_debug.bin')
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: artifacts/sharkos_firmware_debug.bin
          asset_name: sharkos_firmware_debug.bin
          asset_content_type: application/octet-stream

  build_apk:
    name: Build Android APK
    runs-on: self-hosted-linux
    needs: build_firmware
    steps:
      - uses: actions/checkout@v3

      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          components: clippy, rustfmt

      - name: Build APK (debug)
        run: |
          cd android/rust_ui
          export JAVA_HOME=/usr/lib/jvm/java-17-temurin
          export PATH="$$JAVA_HOME/bin:$$PATH"
          cargo tauri android build --debug

      - name: Upload debug APK to release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: android/rust_ui/gen/android/app/build/outputs/apk/universal/debug/app-universal-debug.apk
          asset_name: SharkOS-debug.apk
          asset_content_type: application/vnd.android.package-archive

      - name: Build APK (release)
        run: |
          cd android/rust_ui
          export JAVA_HOME=/usr/lib/jvm/java-17-temurin
          export PATH="$$JAVA_HOME/bin:$$PATH"
          cargo tauri android build --release

      - name: Upload APK to release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: android/rust_ui/gen/android/app/build/outputs/apk/universal/release/app-universal-release-unsigned.apk
          asset_name: SharkOS.apk
          asset_content_type: application/vnd.android.package-archive
